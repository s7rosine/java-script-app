name: Build, test, and push JavaScript App Docker image

on:
  push:
    branches:
      - "main"

jobs:
  build-test-and-push:
    runs-on: label-1

    steps:
      # 1) Checkout your repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Set an IMAGE_NAME env variable like: rosinebelle/javascript-app-httpd
      - name: Set image name
        run: echo "IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/javascript-app-httpd" >> $GITHUB_ENV

      # 3) Build the Docker image from your Dockerfile
      - name: Build Docker image
        run: docker build -t $IMAGE_NAME:latest .

      # 4) Run the container to make sure it starts and serves HTTP
      - name: Run container for test
        run: |
          # Start the container in the background, map port 8080 on runner -> 3000 in container
          docker run -d --name javascript-app-test -p 8080:3000 $IMAGE_NAME:latest
          
          # Wait for app to start
          sleep 3
          
          # Stop and remove the test container
          docker stop javascript-app-test
          docker rm javascript-app-test

      # 5) List all Docker containers
      - name: List Docker containers
        run: docker ps -a

      # 6) Log in to Docker Hub using your secrets
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 7) Push the image to Docker Hub
      - name: Push image to Docker Hub
        run: docker push $IMAGE_NAME:latest

      # 8) Deploy the container on the VM
      - name: Deploy container
        run: |
          # Stop and remove old container if it exists
          docker stop javascript-app 2>/dev/null || true
          docker rm javascript-app 2>/dev/null || true
          
          # Run new container (map VM port 80 to container port 3000)
          docker run -d --name javascript-app -p 80:3000 $IMAGE_NAME:latest

      # 9) Verify deployment
      - name: Verify deployment
        run: |
          echo "Waiting for container to start..."
          sleep 5
          docker ps | grep javascript-app
          echo "Container is running!"